@page
@using EVWarrantyManagement.BO.Constants
@model EVWarrantyManagement.Pages.Bookings.HistoryModel
@{
    ViewData["Title"] = "Service Booking History";
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="mb-1">Service Booking History</h2>
        <p class="text-muted mb-0">Review your completed service appointments and details.</p>
    </div>
    <a class="btn btn-outline-secondary" asp-page="/Bookings/Create">
        <i class="bi bi-calendar-plus me-1"></i>Book New Appointment
    </a>
</div>

@if (!string.IsNullOrWhiteSpace(Model.ErrorMessage))
{
    <div class="alert alert-danger">
        <i class="bi bi-exclamation-triangle me-2"></i>@Model.ErrorMessage
    </div>
}

@if (Model.Bookings.Count == 0)
{
    <div class="card shadow-sm border-0">
        <div class="card-body text-center py-5">
            <i class="bi bi-clipboard-check" style="font-size: 3rem;"></i>
            <p class="mt-3 mb-0 text-muted">You do not have any completed service bookings yet.</p>
        </div>
    </div>
}
else
{
    <div class="card shadow-sm border-0">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Booking</th>
                            <th>Service Center</th>
                            <th>Service Type</th>
                            <th>Appointment</th>
                            <th>Technician</th>
                            <th>Notes</th>
                            <th class="text-end">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var booking in Model.Bookings)
                        {
                            <tr>
                                <td>
                                    <strong>#@booking.ServiceBookingId</strong><br />
                                    <small class="text-muted">Completed @booking.CompletedAt?.ToLocalTime():g</small>
                                </td>
                                <td>
                                    <div>@booking.ServiceCenter?.Name</div>
                                    <small class="text-muted">@booking.ServiceCenter?.Address</small>
                                </td>
                                <td>@booking.ServiceType</td>
                                <td>
                                    <div>@booking.ConfirmedStart?.ToLocalTime():MMM dd, yyyy HH:mm</div>
                                    <small class="text-muted">Duration: @booking.EstimatedDurationMinutes mins</small>
                                </td>
                                <td>
                                    @if (booking.AssignedTechnician != null)
                                    {
                                        <div>@booking.AssignedTechnician.FullName</div>
                                        <small class="text-muted">@booking.AssignedTechnician.Email</small>
                                    }
                                    else
                                    {
                                        <span class="text-muted">N/A</span>
                                    }
                                </td>
                                <td style="max-width: 240px;">
                                    <div class="text-truncate" title="@booking.CustomerNote">@booking.CustomerNote</div>
                                    <small class="text-muted d-block">@booking.InternalNote</small>
                                </td>
                                <td class="text-end d-flex flex-column gap-2 align-items-end">
                                    <a class="btn btn-sm btn-outline-primary" asp-page="/Bookings/Details" asp-route-id="@booking.ServiceBookingId">
                                        <i class="bi bi-eye me-1"></i>View
                                    </a>
                                    @if (string.Equals(booking.Status, ServiceBookingStatuses.Completed, StringComparison.OrdinalIgnoreCase))
                                    {
                                        <a class="btn btn-sm btn-primary" asp-page="/Bookings/Details" asp-page-handler="Invoice" asp-route-id="@booking.ServiceBookingId" target="_blank">
                                            <i class="bi bi-file-earmark-pdf me-1"></i>Invoice (PDF)
                                        </a>
                                    }
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
}
