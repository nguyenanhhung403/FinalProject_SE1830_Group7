@page
@model EVWarrantyManagement.Pages.Bookings.AllModel
@using EVWarrantyManagement.BO.Constants
@{
    ViewData["Title"] = "All Service Bookings";
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="mb-1">All Service Bookings</h2>
        <p class="text-muted mb-0">Track every booking across all service centers.</p>
    </div>
    <div class="d-flex gap-2">
        <a class="btn btn-outline-secondary" asp-page="/Bookings/Review">
            <i class="bi bi-clipboard-check me-1"></i>Review Pending
        </a>
        <a class="btn btn-outline-primary" asp-page="/Dashboard/Index">
            <i class="bi bi-speedometer2 me-1"></i>Dashboard
        </a>
    </div>
</div>

<div class="card shadow-sm border-0 mb-4">
    <div class="card-body">
        <form method="get" class="row g-3 align-items-end">
            <div class="col-sm-4 col-md-3">
                <label asp-for="Status" class="form-label">Status</label>
                <select asp-for="Status" class="form-select">
                    <option value="">-- All statuses --</option>
                    @foreach (var status in Model.StatusOptions)
                    {
                        <option value="@status">@status</option>
                    }
                </select>
            </div>
            <div class="col-sm-4 col-md-3">
                <label asp-for="ServiceCenterId" class="form-label">Service Center</label>
                <select asp-for="ServiceCenterId" class="form-select">
                    <option value="">-- All centers --</option>
                    @foreach (var center in Model.ServiceCenters)
                    {
                        <option value="@center.ServiceCenterId">@center.Name</option>
                    }
                </select>
            </div>
            <div class="col-sm-4 col-md-3">
                <label class="form-label text-white d-none d-sm-block">.</label>
                <button type="submit" class="btn btn-primary w-100">
                    <i class="bi bi-filter-circle me-1"></i>Apply Filters
                </button>
            </div>
            <div class="col-sm-4 col-md-3">
                <label class="form-label text-white d-none d-sm-block">.</label>
                <a class="btn btn-outline-secondary w-100" asp-page="./All">
                    <i class="bi bi-arrow-clockwise me-1"></i>Reset
                </a>
            </div>
        </form>
    </div>
</div>

<div class="card shadow-sm border-0">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Booking</th>
                        <th>Customer</th>
                        <th>Vehicle</th>
                        <th>Service Center</th>
                        <th>Schedule</th>
                        <th>Technician</th>
                        <th>Status</th>
                        <th class="text-end">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model.Bookings.Count == 0)
                    {
                        <tr>
                            <td colspan="8" class="text-center py-4 text-muted">
                                <i class="bi bi-clipboard-data me-2"></i>No bookings found for the selected filters.
                            </td>
                        </tr>
                    }
                    else
                    {
                        foreach (var booking in Model.Bookings)
                        {
                            var scheduleStart = booking.ConfirmedStart ?? booking.PreferredStart;
                            var scheduleEnd = (booking.ConfirmedEnd ?? booking.PreferredEnd) ?? scheduleStart.AddMinutes(Math.Max(booking.EstimatedDurationMinutes, 30));
                            <tr>
                                <td>
                                    <strong>#@booking.ServiceBookingId</strong><br />
                                    <small class="text-muted">Created @booking.CreatedAt.ToLocalTime():g</small>
                                </td>
                                <td>
                                    <div>@booking.Customer?.FullName</div>
                                    <small class="text-muted">@booking.Customer?.Email</small>
                                </td>
                                <td>
                                    <div><code>@booking.Vehicle?.Vin</code></div>
                                    <small class="text-muted">@booking.Vehicle?.Model</small>
                                </td>
                                <td>
                                    <div>@booking.ServiceCenter?.Name</div>
                                    <small class="text-muted">@booking.ServiceCenter?.Address</small>
                                </td>
                                <td>
                                    <div>@scheduleStart.ToLocalTime().ToString("dd/MM/yyyy HH:mm")</div>
                                    <small class="text-muted">Ends @scheduleEnd.ToLocalTime().ToString("HH:mm")</small>
                                </td>
                                <td>
                                    @if (booking.AssignedTechnician != null)
                                    {
                                        <div>@booking.AssignedTechnician.FullName</div>
                                        <small class="text-muted">@booking.AssignedTechnician.Email</small>
                                    }
                                    else
                                    {
                                        <span class="text-muted">Not assigned</span>
                                    }
                                </td>
                                <td>
                                    <span class="badge @GetStatusBadge(booking.Status)">@booking.Status</span>
                                </td>
                                <td class="text-end">
                                    <a class="btn btn-sm btn-outline-primary" asp-page="/Bookings/Details" asp-route-id="@booking.ServiceBookingId">
                                        <i class="bi bi-eye me-1"></i>View
                                    </a>
                                </td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

@functions{
    private static string GetStatusBadge(string? status)
    {
        return status?.ToLowerInvariant() switch
        {
            "pending" => "badge rounded-pill bg-warning text-dark",
            "approved" => "badge rounded-pill bg-primary",
            "inprogress" => "badge rounded-pill bg-info text-dark",
            "completed" => "badge rounded-pill bg-success",
            "rejected" => "badge rounded-pill bg-danger",
            "cancelled" => "badge rounded-pill bg-secondary",
            _ => "badge rounded-pill bg-light text-dark"
        };
    }
}

