@page "{id:int}"
@model EVWarrantyManagement.Pages.Dashboard.Claims.DetailModel
@attribute [Microsoft.AspNetCore.Authorization.Authorize(Policy="RequireEVM")]
@{
    ViewData["Title"] = $"Claim #{Model.Claim?.ClaimId}";
}

<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a asp-page="/Dashboard/Index">Dashboard</a></li>
        <li class="breadcrumb-item"><a asp-page="/Claims/Index">Claims</a></li>
        <li class="breadcrumb-item active" aria-current="page">Detail</li>
    </ol>
</nav>

@if (Model.Claim is null)
{
    <div class="alert alert-danger">Claim not found.</div>
    return;
}

<h2 class="mb-3">Claim #@Model.Claim.ClaimId</h2>

<div class="row g-3 mb-4">
    <div class="col-md-6">
        <dl class="row">
            <dt class="col-sm-4">Model</dt>
            <dd class="col-sm-8">@Model.Claim.Vehicle?.Model</dd>
            <dt class="col-sm-4">VIN</dt>
            <dd class="col-sm-8">@Model.Claim.Vin</dd>
            <dt class="col-sm-4">Service Center</dt>
            <dd class="col-sm-8">@Model.Claim.ServiceCenter?.Name</dd>
            <dt class="col-sm-4">Status</dt>
            <dd class="col-sm-8"><span class="badge bg-secondary">@Model.Claim.StatusCode</span></dd>
            <dt class="col-sm-4">Created</dt>
            <dd class="col-sm-8">@Model.Claim.CreatedAt</dd>
        </dl>
    </div>
    <div class="col-md-6">
        <dl class="row">
            <dt class="col-sm-4">Technician</dt>
            <dd class="col-sm-8">@Model.Claim.Technician?.FullName</dd>
            <dt class="col-sm-4">Completion Date</dt>
            <dd class="col-sm-8">@Model.Claim.CompletionDate</dd>
            <dt class="col-sm-4">Total Cost</dt>
            <dd class="col-sm-8">@Model.Claim.TotalCost?.ToString("C")</dd>
        </dl>
    </div>
</div>

@if (!string.IsNullOrWhiteSpace(Model.Claim.Description))
{
    <div class="mb-4">
        <h5>Description</h5>
        <p>@Model.Claim.Description</p>
    </div>
}

@if (!string.IsNullOrWhiteSpace(Model.Claim.Note))
{
    <div class="mb-4">
        <h5>Current Note</h5>
        <p class="text-muted">@Model.Claim.Note</p>
    </div>
}

@{
    var currentStatus = Model.Claim.StatusCode ?? string.Empty;
    var isPending = string.Equals(currentStatus, "Pending", StringComparison.OrdinalIgnoreCase);
    var isOnHold = string.Equals(currentStatus, "OnHold", StringComparison.OrdinalIgnoreCase);
    var isCompleted = string.Equals(currentStatus, "Completed", StringComparison.OrdinalIgnoreCase);
    var isClosed = string.Equals(currentStatus, "Closed", StringComparison.OrdinalIgnoreCase);
    var canApprove = isPending || isOnHold;
    var showArchive = isCompleted;
    var showActions = !isClosed && (isPending || canApprove || showArchive);
}

@if (showActions)
{
    <h5>Review Actions</h5>
    <form method="post" class="row g-3">
        <input type="hidden" asp-for="ClaimId" />
        <div class="col-md-6">
            <label asp-for="Note" class="form-label">Note</label>
            <textarea asp-for="Note" class="form-control" rows="3" placeholder="Add a note (optional)"></textarea>
        </div>
        <div class="col-md-6 d-flex align-items-end gap-2">
            @if (isPending)
            {
                <button class="btn btn-success" formaction="?handler=Approve" type="submit">Approve</button>
                <button class="btn btn-danger" formaction="?handler=Reject" type="submit">Reject</button>
                <button class="btn btn-warning" formaction="?handler=Hold" type="submit">On Hold</button>
            }
            else if (canApprove)
            {
                <button class="btn btn-success" formaction="?handler=Approve" type="submit">Approve</button>
            }
            @if (showArchive)
            {
                <button class="btn btn-outline-dark" formaction="?handler=Archive" type="submit">Archive</button>
            }
            <a class="btn btn-secondary ms-auto" asp-page="/Dashboard/Index">Back</a>
        </div>
    </form>
}
else
{
    <div class="mt-4">
        <a class="btn btn-secondary" asp-page="/Dashboard/Index">Back</a>
    </div>
}

