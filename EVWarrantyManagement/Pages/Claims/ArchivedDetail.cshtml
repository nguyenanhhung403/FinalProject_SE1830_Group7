@page "{id:int}"
@using System.Linq
@model EVWarrantyManagement.Pages.Claims.ArchivedDetailModel
@{
    ViewData["Title"] = $"Archived Claim #{Model.History?.ClaimId}";
}

<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a asp-page="/Dashboard/Index">Dashboard</a></li>
        <li class="breadcrumb-item"><a asp-page="/Claims/Archived">Archived Claims</a></li>
        <li class="breadcrumb-item active" aria-current="page">Detail</li>
    </ol>
</nav>

@if (Model.History is null)
{
    <div class="alert alert-danger">Archived claim not found.</div>
    return;
}

@{
    var history = Model.History!;
}

<h2 class="mb-3">Claim #@history.ClaimId</h2>

@if (User.IsInRole("SC Staff") || User.IsInRole("SC"))
{
    <div class="mb-3">
        <a class="btn btn-outline-primary" asp-page-handler="DownloadInvoice" asp-route-id="@history.HistoryId">
            <i class="bi bi-file-earmark-arrow-down"></i> Tải hóa đơn (PDF)
        </a>
    </div>
}

<div class="row g-3 mb-4">
    <div class="col-md-6">
        <dl class="row">
            <dt class="col-sm-4">Model</dt>
            <dd class="col-sm-8">@((history.Vehicle?.Model) ?? "N/A")</dd>
            <dt class="col-sm-4">VIN</dt>
            <dd class="col-sm-8">@history.Vin</dd>
            <dt class="col-sm-4">Service Center</dt>
            <dd class="col-sm-8">@((history.ServiceCenter?.Name) ?? $"#{history.ServiceCenterId}")</dd>
            <dt class="col-sm-4">Completed By</dt>
            <dd class="col-sm-8">@((history.CompletedByUser?.FullName) ?? $"User #{history.CompletedByUserId}")</dd>
        </dl>
    </div>
    <div class="col-md-6">
        <dl class="row">
            <dt class="col-sm-4">Completion Date</dt>
            <dd class="col-sm-8">@history.CompletionDate</dd>
            <dt class="col-sm-4">Total Cost</dt>
            <dd class="col-sm-8">@history.TotalCost?.ToString("C")</dd>
            <dt class="col-sm-4">Archived At</dt>
            <dd class="col-sm-8">@history.ArchivedAt</dd>
        </dl>
    </div>
</div>

@if (!string.IsNullOrWhiteSpace(history.Note))
{
    <div class="mb-4">
        <h5>Note</h5>
        <p>@history.Note</p>
    </div>
}

<h5>Used Parts</h5>
@if (Model.UsedParts.Any())
{
    <div class="table-responsive mb-4">
        <table class="table table-striped table-sm">
            <thead>
                <tr>
                    <th>Part</th>
                    <th>Quantity</th>
                    <th>Cost</th>
                    <th>Recorded At</th>
                </tr>
            </thead>
            <tbody>
            @foreach (var part in Model.UsedParts)
            {
                <tr>
                    <td>
                        @if (part.Part is not null)
                        {
                            @(string.IsNullOrWhiteSpace(part.Part.PartCode)
                                ? part.Part.PartName
                                : $"{part.Part.PartCode} - {part.Part.PartName}")
                        }
                        else
                        {
                            @($"Part #{part.PartId}")
                        }
                    </td>
                    <td>@part.Quantity</td>
                    <td>@part.PartCost</td>
                    <td>@part.CreatedAt</td>
                </tr>
            }
            </tbody>
        </table>
    </div>
}
else
{
    <p class="text-muted">No parts were recorded for this claim.</p>
}

<a class="btn btn-secondary" asp-page="/Claims/Archived">Back</a>

