@page "{id:int}"
@model EVWarrantyManagement.Pages.Claims.DetailsModel
@using System.Security.Claims
@{
    ViewData["Title"] = "Claim Details";
    bool isSCStaff = User.IsInRole("SC Staff");
    bool isTechnician = User.IsInRole("SC Technician") || (!isSCStaff && User.IsInRole("SC"));
    bool isEVM = User.IsInRole("EVM Staff") || User.IsInRole("EVM");
    bool isAdmin = User.IsInRole("Admin");
    var status = Model.Claim?.StatusCode ?? string.Empty;
    bool isCompletedStatus = string.Equals(status, "Completed", StringComparison.OrdinalIgnoreCase) || string.Equals(status, "Archived", StringComparison.OrdinalIgnoreCase);
    bool canManageParts = isTechnician && !isCompletedStatus;
}

<nav aria-label="breadcrumb" class="mb-4">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a asp-page="/Claims/Index"><i class="bi bi-house me-1"></i>Claims</a></li>
        <li class="breadcrumb-item active" aria-current="page">Claim #@Model.Claim?.ClaimId</li>
    </ol>
</nav>

@if (TempData["Success"] is string successMessage)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="bi bi-check-circle me-2"></i>@successMessage
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}
@if (TempData["Warning"] is string warningMessage)
{
    <div class="alert alert-warning alert-dismissible fade show" role="alert">
        <i class="bi bi-exclamation-circle me-2"></i>@warningMessage
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}
@if (TempData["Error"] is string errorMessage)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="bi bi-exclamation-triangle me-2"></i>@errorMessage
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<div class="mb-4">
    <h2 class="mb-1">
        <i class="bi bi-file-earmark-text me-2"></i>Claim #@Model.Claim?.ClaimId
    </h2>
    <p class="text-muted mb-0">Warranty claim details and management</p>
</div>

<div class="card shadow-sm border-0 mb-4">
    <div class="card-header gradient-primary">
        <h5 class="mb-0 text-white">
            <i class="bi bi-info-circle me-2"></i>Claim Information
        </h5>
    </div>
    <div class="card-body">
        <dl class="row mb-0">
            <dt class="col-sm-3 d-flex align-items-center">
                <i class="bi bi-car-front text-primary me-2"></i>Model
            </dt>
            <dd class="col-sm-9">@Model.Claim?.Vehicle?.Model ?? "N/A"</dd>
            <dt class="col-sm-3 d-flex align-items-center">
                <i class="bi bi-upc-scan text-primary me-2"></i>VIN
            </dt>
            <dd class="col-sm-9"><code>@Model.Claim?.Vin</code></dd>
            <dt class="col-sm-3 d-flex align-items-center">
                <i class="bi bi-building text-primary me-2"></i>Service Center
            </dt>
            <dd class="col-sm-9">@Model.Claim?.ServiceCenter?.Name</dd>
            <dt class="col-sm-3 d-flex align-items-center">
                <i class="bi bi-calendar3 text-primary me-2"></i>Date Discovered
            </dt>
            <dd class="col-sm-9">@Model.Claim?.DateDiscovered.ToString("MM/dd/yyyy")</dd>
            <dt class="col-sm-3 d-flex align-items-center">
                <i class="bi bi-flag text-primary me-2"></i>Status
            </dt>
            <dd class="col-sm-9">
                @{
                    var claimStatus = Model.Claim?.StatusCode ?? string.Empty;
                    var statusClass = claimStatus.ToLower() switch {
                        "pending" => "status-pending",
                        "approved" => "status-approved",
                        "rejected" => "status-rejected",
                        "inprogress" => "status-inprogress",
                        "completed" => "status-completed",
                        "archived" => "status-archived",
                        "onhold" => "status-onhold",
                        "closed" => "status-closed",
                        _ => "bg-secondary"
                    };
                }
                <span class="badge @statusClass">@Model.Claim?.StatusCode</span>
            </dd>
            <dt class="col-sm-3 d-flex align-items-center">
                <i class="bi bi-file-text text-primary me-2"></i>Description
            </dt>
            <dd class="col-sm-9">@Model.Claim?.Description</dd>
            @if (!string.IsNullOrWhiteSpace(Model.Claim?.ImageUrl))
            {
                <dt class="col-sm-3 d-flex align-items-center">
                    <i class="bi bi-image text-primary me-2"></i>Image
                </dt>
                <dd class="col-sm-9">
                    <img src="@Model.Claim!.ImageUrl" alt="evidence" class="img-fluid rounded shadow-sm" style="max-width: 400px;" />
                </dd>
            }
        </dl>
    </div>
</div>

<div class="card shadow-sm border-0 mb-4">
    <div class="card-header gradient-info">
        <h5 class="mb-0 text-white">
            <i class="bi bi-gear me-2"></i>Used Parts
        </h5>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
        <thead>
                <tr>
                <th>Part</th>
                <th>Qty</th>
                <th>Cost</th>
                <th>At</th>
                    @if (canManageParts)
                    {
                        <th class="text-end">Actions</th>
                    }
            </tr>
        </thead>
        <tbody>
            @foreach (var p in Model.Claim?.UsedParts ?? Enumerable.Empty<EVWarrantyManagement.BO.Models.UsedPart>())
            {
                <tr>
                    <td>
                        @if (p.Part is not null)
                        {
                            @(string.IsNullOrWhiteSpace(p.Part.PartCode)
                                ? p.Part.PartName
                                : $"{p.Part.PartCode} - {p.Part.PartName}")
                        }
                        else
                        {
                            @($"Part #{p.PartId}")
                        }
                    </td>
                    <td>@p.Quantity</td>
                    <td>@p.PartCost</td>
                    <td>@p.CreatedAt</td>
                    @if (canManageParts)
                    {
                        <td class="text-end">
                            <form method="post"
                                  asp-page-handler="DeleteUsedPart"
                                  asp-route-id="@Model.Claim?.ClaimId"
                                  asp-route-usedPartId="@p.UsedPartId"
                                  onsubmit="return confirm('Xoá linh kiện này khỏi yêu cầu?');">
                                <button type="submit" class="btn btn-outline-danger btn-sm">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </form>
                        </td>
                    }
                </tr>
            }
        </tbody>
            </table>
        </div>
    </div>
</div>

@if (TempData["AiSuggestion"] is string aiSuggestion)
{
    <div class="mt-4">
        <div class="card border-info">
            <div class="card-header bg-info text-white d-flex align-items-center">
                <i class="bi bi-stars me-2"></i>
                <strong>AI Suggestion</strong>
            </div>
            <div class="card-body">
                <div class="ai-suggestion-content" style="white-space: pre-wrap; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; line-height: 1.6; max-height: 600px; overflow-y: auto; padding: 1rem;">
                    @{
                        // Simple markdown rendering
                        var formatted = aiSuggestion;
                        // Convert **text** to <strong>text</strong>
                        var regex = new System.Text.RegularExpressions.Regex(@"\*\*(.*?)\*\*");
                        formatted = regex.Replace(formatted, "<strong>$1</strong>");
                        // Convert line breaks
                        formatted = formatted.Replace("\n", "<br/>");
                    }
                    @Html.Raw(formatted)
                </div>
            </div>
        </div>
    </div>
}

@if (isTechnician && !isCompletedStatus)
{
<h5 class="mt-3">Add Used Part</h5>
<form method="post" asp-page-handler="AddPart" class="row gy-2 gx-2">
    <input type="hidden" asp-for="ClaimId" />
    <div class="col-md-4">
        <select class="form-select" asp-for="AddPartInput.PartId" id="partSelect">
            <option value="">-- Select Part --</option>
            @foreach (var option in Model.PartOptions)
            {
                <option value="@option.PartId" data-price="@option.UnitPrice">@option.Display</option>
            }
        </select>
        <span asp-validation-for="AddPartInput.PartId" class="text-danger"></span>
    </div>
    <div class="col-md-2">
        <input class="form-control" asp-for="AddPartInput.Quantity" id="quantityInput" placeholder="Qty" min="1" />
        <span asp-validation-for="AddPartInput.Quantity" class="text-danger"></span>
    </div>
    <div class="col-md-3">
        <input class="form-control" asp-for="AddPartInput.PartCost" id="costInput" placeholder="Total Cost" step="0.01" min="0" />
        <span asp-validation-for="AddPartInput.PartCost" class="text-danger"></span>
    </div>
    <div class="col-md-2">
        <button class="btn btn-primary w-100" type="submit">Add</button>
    </div>
</form>
}

<div class="mt-4 d-flex gap-2">
    <a class="btn btn-secondary" asp-page="Index">Back</a>
    @if (isEVM)
    {
        var isPending = string.Equals(status, "Pending", StringComparison.OrdinalIgnoreCase);
        var isOnHold = string.Equals(status, "OnHold", StringComparison.OrdinalIgnoreCase);
        var isCompleted = string.Equals(status, "Completed", StringComparison.OrdinalIgnoreCase);
        var isClosed = string.Equals(status, "Closed", StringComparison.OrdinalIgnoreCase);
        var canApprove = isPending || isOnHold;
        var showArchive = isCompleted;
        var showEVMButtons = !isClosed && (isPending || canApprove || showArchive);
        
        @if (showEVMButtons)
        {
            @if (isPending)
            {
                <form method="post" asp-page-handler="Approve"><input type="hidden" name="id" value="@Model.ClaimId" /><button class="btn btn-success" type="submit">Approve</button></form>
                <form method="post" asp-page-handler="Reject"><input type="hidden" name="id" value="@Model.ClaimId" /><button class="btn btn-danger" type="submit">Reject</button></form>
                <form method="post" asp-page-handler="OnHold"><input type="hidden" name="id" value="@Model.ClaimId" /><button class="btn btn-warning" type="submit">On Hold</button></form>
            }
            else if (canApprove)
            {
                <form method="post" asp-page-handler="Approve"><input type="hidden" name="id" value="@Model.ClaimId" /><button class="btn btn-success" type="submit">Approve</button></form>
            }
            @if (showArchive)
            {
                <form method="post" asp-page-handler="Archive"><input type="hidden" name="id" value="@Model.ClaimId" /><button class="btn btn-outline-dark" type="submit">Archive</button></form>
            }
        }
    }
    @if (isTechnician)
    {
        if (!isCompletedStatus)
        {
            <form method="post" asp-page-handler="AiSuggest" asp-route-id="@Model.ClaimId" class="d-flex flex-column flex-sm-row align-items-sm-center gap-2">
                <button class="btn btn-outline-info" type="submit">
                    <i class="bi bi-stars me-1"></i> AI Suggest
                </button>
            </form>
        }
        if (!isCompletedStatus && string.Equals(status, "Approved", StringComparison.OrdinalIgnoreCase))
        {
            <form method="post" asp-page-handler="Start" class="d-flex flex-column flex-sm-row align-items-sm-center gap-2">
                <input type="hidden" name="id" value="@Model.ClaimId" />
                <input type="text" name="technicianNote" class="form-control form-control-sm" placeholder="Repair note (optional)" />
                <button class="btn btn-primary" type="submit">Start Repair</button>
            </form>
        }
        if (string.Equals(status, "InProgress", StringComparison.OrdinalIgnoreCase))
        {
            <form method="post" asp-page-handler="Complete" class="d-flex flex-column flex-sm-row align-items-sm-center gap-2">
                <input type="hidden" name="id" value="@Model.ClaimId" />
                <input type="text" name="technicianNote" class="form-control form-control-sm" placeholder="Completion note (optional)" />
                <button class="btn btn-success" type="submit">Mark Completed</button>
            </form>
        }
    }
    @if (isAdmin && string.Equals(status, "Completed", StringComparison.OrdinalIgnoreCase))
    {
        <form method="post" asp-page-handler="Archive"><input type="hidden" name="id" value="@Model.ClaimId" /><button class="btn btn-outline-dark" type="submit">Archive</button></form>
    }
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        (function () {
            const partSelect = document.getElementById('partSelect');
            const qtyInput = document.getElementById('quantityInput');
            const costInput = document.getElementById('costInput');

            function sanitizeQuantity() {
                let qty = parseInt(qtyInput?.value, 10);
                if (isNaN(qty) || qty < 1) {
                    qty = 1;
                }
                if (qtyInput) {
                    qtyInput.value = qty;
                }
                return qty;
            }

            function updateCost() {
                const option = partSelect?.selectedOptions?.[0];
                const price = option ? parseFloat(option.dataset.price || '0') : 0;
                const qty = sanitizeQuantity();

                if (!costInput) return;
                if (!price) {
                    if (!costInput.value) {
                        costInput.value = '';
                    }
                    return;
                }

                const total = price * qty;
                costInput.value = total.toFixed(2);
            }

            partSelect?.addEventListener('change', updateCost);
            qtyInput?.addEventListener('input', updateCost);
        })();
    </script>
}

